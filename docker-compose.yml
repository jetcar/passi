version: '3.4'

services:
  database:
    image: 'postgres:15.3'
    container_name: postgres
    networks:
      - dock_net
    ports:
      - "5432:5432"
    env_file:
      - ./configs/variables/dev.env
    volumes:
      - type: bind
        source: ../db-data2/
        target: /var/lib/postgresql/data/
    restart: always
    
  pgadmin:
    image: 'dpage/pgadmin4:7.4'
    container_name: pgadmin
    networks:
      - dock_net
    env_file:
      - ./configs/variables/dev.env
    restart: always
    depends_on:
      - database
    volumes:
      - ./configs/pgadmin/:/etc/pgadmin/:ro #config
      - ../pgadmin/:/var/lib/pgadmin/:rw

  redis:
    image: 'redis/redis-stack-server:7.0.6-RC5'
    container_name: redis
    networks:
    - dock_net
    #env_file:
    #- ./configs/variables/dev.env
    restart: always
    volumes:
      - ../redis_data/:/data

  haproxy:
    container_name: haproxy
    image: haproxy:2.8.1
    volumes:
      - ./configs/haproxy:/usr/local/etc/haproxy
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - passiwebapi
      - webapp
      - identityserver
    networks:
      - dock_net

  webapp:
    build:
      context: .
      dockerfile: WebApp/Dockerfile
    networks:
      - dock_net
    ports:
      - "5002:5002"
    env_file:
      - ./configs/variables/dev.env
    volumes:
      - ../creds:/home/creds
    depends_on:
      - database
    restart: always

  identityserver:
    build:
      context: .
      dockerfile: IdentityServer/Dockerfile
    networks:
      - dock_net
    ports:
      - "5003:5003"
    container_name: identityserver
    env_file:
      - ./configs/variables/dev.env
    volumes:
      - ../creds:/home/creds
    depends_on:
      - database
      - passiwebapi
    restart: always

  passiwebapi:
    build:
      context: .
      dockerfile: passiwebapi/Dockerfile
    networks:
      - dock_net
    ports:
      - "5004:5004"
    depends_on:
      - database
      - redis
    env_file:
      - ./configs/variables/dev.env
    volumes:
      - ../creds:/home/creds
    restart: always
    
networks:
  dock_net:
    driver: bridge




